name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          Restart-Service -Name TermService -Force

      - name: Create RDP User with Secure Password
        run: |
          $password = "!Ks2025"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          
          # RDP à¦‡à¦‰à¦œà¦¾à¦°à§‡à¦° à¦ªà§à¦°à§‹à¦«à¦¾à¦‡à¦² à¦«à§‹à¦²à§à¦¡à¦¾à¦° à¦¤à§ˆà¦°à¦¿ à¦•à¦°à¦¤à§‡ à¦²à¦—à¦‡à¦¨/à¦²à¦—à¦†à¦‰à¦Ÿ à¦•à¦°à¦¾à¦¨
          # New-LocalUser à¦à¦° à¦®à¦¾à¦§à§à¦¯à¦®à§‡ à¦ªà§à¦°à§‹à¦«à¦¾à¦‡à¦² à¦…à¦Ÿà§‹ à¦¤à§ˆà¦°à¦¿ à¦¹à§Ÿ
          
          echo "RDP_CREDS=User: RDP | Password: $password" >> $env:GITHUB_ENV

      - name: Download File to RDP User's Temp Folder
        run: |
          # RDP à¦‡à¦‰à¦œà¦¾à¦°à§‡à¦° à¦ªà§à¦°à§‹à¦«à¦¾à¦‡à¦² à¦«à§‹à¦²à§à¦¡à¦¾à¦° à¦¤à§ˆà¦°à¦¿ à¦¹à§Ÿà§‡à¦›à§‡ à¦•à¦¿à¦¨à¦¾ à¦¨à¦¿à¦¶à§à¦šà¦¿à¦¤ à¦•à¦°à§à¦¨
          $rdpProfilePath = "C:\Users\RDP"
          $rdpTempPath = "C:\Users\RDP\AppData\Local\Temp"
          
          # à¦¯à¦¦à¦¿ à¦ªà§à¦°à§‹à¦«à¦¾à¦‡à¦² à¦«à§‹à¦²à§à¦¡à¦¾à¦° à¦¨à¦¾ à¦¥à¦¾à¦•à§‡, à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨
          if (-not (Test-Path $rdpProfilePath)) {
              New-Item -ItemType Directory -Force -Path $rdpProfilePath
          }
          
          # Temp à¦«à§‹à¦²à§à¦¡à¦¾à¦° à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨
          New-Item -ItemType Directory -Force -Path $rdpTempPath
          
          # à¦¯à¦¦à¦¿ SECRET-à¦ URL à¦¥à¦¾à¦•à§‡
          $downloadUrl = "${{ secrets.FILE_DOWNLOAD_URL }}"
          if (-not [string]::IsNullOrEmpty($downloadUrl)) {
              $outputPath = "$rdpTempPath\New_folder.zip"
              Write-Host "Downloading to RDP user's temp: $outputPath"
              
              try {
                  Invoke-WebRequest -Uri $downloadUrl -OutFile $outputPath -TimeoutSec 45 -ErrorAction Stop
                  
                  if (Test-Path $outputPath) {
                      $fileSize = (Get-Item $outputPath).Length
                      Write-Host "âœ… File downloaded successfully"
                      Write-Host "ðŸ“ Location: $outputPath"
                      Write-Host "ðŸ“¦ Size: $fileSize bytes"
                      
                      # à¦ªà¦¾à¦°à¦®à¦¿à¦¶à¦¨ à¦¸à§‡à¦Ÿ à¦•à¦°à§à¦¨
                      icacls $outputPath /grant "RDP:(F)" /inheritance:r
                      
                      echo "DOWNLOADED_FILE_PATH=$outputPath" >> $env:GITHUB_ENV
                  }
              } catch {
                  Write-Host "âš ï¸ Download failed: $_"
                  # à¦¸à§à¦¯à¦¾à¦®à§à¦ªà¦² à¦«à¦¾à¦‡à¦² à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨
                  $sampleFile = "$rdpTempPath\readme.txt"
                  "RDP Temp Folder - $(Get-Date)" | Out-File $sampleFile
                  icacls $sampleFile /grant "RDP:(F)" /inheritance:r
                  Write-Host "Created sample file instead"
              }
          } else {
              Write-Host "â„¹ï¸ No download URL in secrets"
              # à¦¸à§à¦¯à¦¾à¦®à§à¦ªà¦² à¦«à¦¾à¦‡à¦² à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨
              $sampleFile = "$rdpTempPath\note.txt"
              "Place your files here in C:\Users\RDP\AppData\Local\Temp" | Out-File $sampleFile
              icacls $sampleFile /grant "RDP:(F)" /inheritance:r
              Write-Host "Created placeholder file"
          }
          
          # à¦«à§‹à¦²à§à¦¡à¦¾à¦° à¦ªà¦¾à¦°à¦®à¦¿à¦¶à¦¨ à¦¸à§‡à¦Ÿ à¦•à¦°à§à¦¨
          icacls $rdpTempPath /grant "RDP:(F)" /T /inheritance:r
          Write-Host "Permissions set for RDP user"

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
          
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
      
      - name: Verify RDP Accessibility
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Maintain Connection
        run: |
          Write-Host "`n=== RDP ACCESS ==="
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: RDP"
          Write-Host "Password: !Ks2025"
          Write-Host "`n=== DOWNLOADED FILE ==="
          if (-not [string]::IsNullOrEmpty($env:DOWNLOADED_FILE_PATH)) {
              Write-Host "Location: $env:DOWNLOADED_FILE_PATH"
          } else {
              Write-Host "Location: C:\Users\RDP\AppData\Local\Temp\New_folder.zip"
          }
          Write-Host "==================`n"
          
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C to terminate"
              Start-Sleep -Seconds 300
          }
