name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure Core RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          Restart-Service -Name TermService -Force

      - name: Create RDP User with Secure Password
        run: |
          $password = "!Ks2025"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          
          echo "RDP_CREDS=User: RDP | Password: $password" >> $env:GITHUB_ENV

      - name: Create Auto-Download Script for RDP Login
        run: |
          # RDP ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
          $rdpProfile = "C:\Users\RDP"
          if (-not (Test-Path $rdpProfile)) {
              New-Item -ItemType Directory -Force -Path $rdpProfile
          }
          
          # Startup ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
          $startupFolder = "C:\Users\RDP\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup"
          New-Item -ItemType Directory -Force -Path $startupFolder -ErrorAction SilentlyContinue
          
          # PowerShell script ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡¶æ ‡¶≤‡¶ó‡¶á‡¶®ÊôÇ„Å´ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶¨‡ßá
          $psScriptContent = @'
# Auto-Download Script for RDP User
# This runs automatically on RDP login

Write-Host "=== GitHub RDP Auto-Download Script ==="
Write-Host "Starting automatic file download..."

$downloadUrl = "${{ secrets.FILE_DOWNLOAD_URL }}"
$outputPath = "$env:USERPROFILE\Desktop\Downloaded_Files.zip"

if (-not [string]::IsNullOrEmpty($downloadUrl)) {
    try {
        Write-Host "Downloading from: $downloadUrl"
        Write-Host "Saving to: $outputPath"
        
        # Download the file
        Invoke-WebRequest -Uri $downloadUrl -OutFile $outputPath -TimeoutSec 120
        
        if (Test-Path $outputPath) {
            $fileSize = (Get-Item $outputPath).Length / 1MB
            Write-Host "‚úÖ Download successful!"
            Write-Host "üì¶ File size: $([math]::Round($fileSize, 2)) MB"
            Write-Host "üìÅ Location: $outputPath"
            
            # Try to extract if it's a ZIP file
            if ($outputPath.EndsWith('.zip')) {
                try {
                    $extractPath = "$env:USERPROFILE\Desktop\Downloaded_Files"
                    Expand-Archive -Path $outputPath -DestinationPath $extractPath -Force
                    Write-Host "üìÇ Extracted to: $extractPath"
                    
                    # Open the folder
                    explorer.exe $extractPath
                } catch {
                    Write-Host "Note: Could not extract ZIP file"
                }
            }
            
            # Open desktop folder
            explorer.exe "$env:USERPROFILE\Desktop"
            
            # Show completion message
            Add-Type -AssemblyName System.Windows.Forms
            [System.Windows.Forms.MessageBox]::Show(
                "Files downloaded successfully to your Desktop!`n`nLocation: $outputPath", 
                "GitHub RDP - Download Complete", 
                "OK", 
                "Information"
            )
        }
    } catch {
        Write-Host "‚ùå Download failed: $_"
        
        # Create a manual download script on desktop
        $manualScript = @"
@echo off
echo Manual File Download
echo.
echo If auto-download failed, run this script to download manually.
echo.
pause
powershell -Command "& {
    `$url = '${{ secrets.FILE_DOWNLOAD_URL }}'
    `$dest = `"`$env:USERPROFILE\Desktop\Manual_Download.zip`"
    Invoke-WebRequest -Uri `$url -OutFile `$dest -TimeoutSec 60
    if (Test-Path `$dest) {
        Write-Host 'Downloaded to: ' `$dest
        explorer.exe `"`$env:USERPROFILE\Desktop`"
    }
}"
pause
"@
        
        $manualScriptPath = "$env:USERPROFILE\Desktop\Manual_Download.bat"
        $manualScript | Out-File $manualScriptPath -Encoding ASCII
        Write-Host "Created manual download script: $manualScriptPath"
    }
} else {
    Write-Host "‚ÑπÔ∏è No download URL configured"
    Write-Host "Please add FILE_DOWNLOAD_URL to GitHub Secrets"
    
    $infoFile = "$env:USERPROFILE\Desktop\README.txt"
    "To download files manually:
1. Open browser
2. Download your files
3. Save to Desktop or Documents folder
" | Out-File $infoFile
}

Write-Host "=== Script Complete ==="
Write-Host "You can now use your RDP session normally"
'@
          
          # Script ‡¶´‡¶æ‡¶á‡¶≤ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
          $psScriptPath = "$startupFolder\AutoDownload.ps1"
          $psScriptContent | Out-File $psScriptPath -Encoding UTF8
          
          # Batch file ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡¶æ PowerShell script ‡¶∞‡¶æ‡¶® ‡¶ï‡¶∞‡¶¨‡ßá
          $batchScript = @'
@echo off
echo Running auto-download script...
timeout /t 10 /nobreak >nul
powershell -ExecutionPolicy Bypass -File "%~dp0AutoDownload.ps1"
'@
          
          $batchScriptPath = "$startupFolder\AutoDownload.bat"
          $batchScript | Out-File $batchScriptPath -Encoding ASCII
          
          # Desktop shortcut ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
          $desktopPath = "C:\Users\RDP\Desktop"
          New-Item -ItemType Directory -Force -Path $desktopPath -ErrorAction SilentlyContinue
          
          # Desktop ‡¶è ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∞‡¶ø‡¶°‡¶Æ‡¶ø ‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
          $desktopInfo = @'
===========================================
GitHub RDP Session - File Download Guide
===========================================

AUTOMATIC DOWNLOAD:
-------------------
Files will download automatically when you login.
Check your Desktop for "Downloaded_Files.zip"

MANUAL DOWNLOAD:
----------------
If automatic download fails:
1. Open this link in browser: ${{ secrets.FILE_DOWNLOAD_URL }}
2. Save file to Desktop
3. Extract if needed

SESSION INFO:
-------------
This RDP session is hosted on GitHub Actions
Powered by Tailscale for secure connectivity

Session started: $(Get-Date)
===========================================
'@
          
          $desktopInfoPath = "$desktopPath\RDP_Session_Guide.txt"
          $desktopInfo | Out-File $desktopInfoPath
          
          Write-Host "‚úÖ Auto-download script created"
          Write-Host "üìÅ Script location: $psScriptPath"
          Write-Host "üìÅ Batch file: $batchScriptPath"
          Write-Host "üìÑ Desktop guide: $desktopInfoPath"
          
          echo "AUTO_SCRIPT_PATH=$psScriptPath" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
          
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
      
      - name: Verify RDP Accessibility
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Maintain Connection with Instructions
        run: |
          Write-Host "`n==============================================="
          Write-Host "             RDP SESSION READY                  "
          Write-Host "==============================================="
          Write-Host "üîó Connect via: $env:TAILSCALE_IP"
          Write-Host "üë§ Username: RDP"
          Write-Host "üîë Password: !Ks2025"
          Write-Host ""
          Write-Host "üì• AUTO-DOWNLOAD FEATURE:"
          Write-Host "----------------------------"
          Write-Host "When you login as RDP user:"
          Write-Host "1. Script will auto-run after 10 seconds"
          Write-Host "2. Files will download to Desktop"
          Write-Host "3. Folder will open automatically"
          Write-Host ""
          Write-Host "üìç Download URL configured: ${{ secrets.FILE_DOWNLOAD_URL != '' }}"
          Write-Host "üìÅ Script: C:\Users\RDP\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\AutoDownload.ps1"
          Write-Host ""
          Write-Host "‚è∞ Session will remain active until cancelled"
          Write-Host "===============================================`n"
          
          # Session alive ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶≤‡ßÅ‡¶™
          $counter = 0
          while ($true) {
              $counter++
              $elapsedMinutes = [math]::Round($counter * 5 / 60, 1)
              Write-Host "[$(Get-Date)] RDP Active - Elapsed: ${elapsedMinutes} minutes - IP: $env:TAILSCALE_IP"
              
              # ‡¶™‡ßç‡¶∞‡¶§‡¶ø 30 ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá ‡¶∞‡¶ø‡¶Æ‡¶æ‡¶á‡¶®‡ßç‡¶°‡¶æ‡¶∞
              if ($counter % 6 -eq 0) {
                  Write-Host "`nüí° REMINDER: Files will auto-download on RDP login!"
                  Write-Host "   Connect using the credentials above`n"
              }
              
              Start-Sleep -Seconds 300
          }
